<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set up Meitheal</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:       #0d0d0d;
      --bg-card:  #161616;
      --bg-input: #1e1e1e;
      --bg-muted: #1a1a1a;
      --border:   #2a2a2a;
      --border-hi:#3a3a3a;
      --text:     #efefef;
      --text-2:   #999;
      --text-3:   #555;
      --primary:  #4b8cf5;
      --primary-d:#3a7ae8;
      --green:    #34d399;
      --red:      #f87171;
      --yellow:   #fbbf24;
      --radius:   10px;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --mono: 'SF Mono', 'Fira Code', 'Fira Mono', monospace;
    }
    body {
      background: var(--bg); color: var(--text); font-family: var(--font);
      min-height: 100dvh; display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }

    /* ---- Loading ------------------------------------------ */
    #screen-loading {
      text-align: center;
      color: var(--text-2);
      font-size: 14px;
    }
    .spinner {
      width: 28px; height: 28px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- Env vars guide ----------------------------------- */
    #screen-noenv {
      max-width: 560px; width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
    }

    /* ---- Main card --------------------------------------- */
    #card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }

    .logo {
      font-size: 20px; font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }
    .logo-sub {
      font-size: 13px; color: var(--text-2);
      margin-bottom: 28px;
    }

    /* Progress */
    .progress {
      display: flex; gap: 5px; margin-bottom: 28px;
    }
    .pd {
      height: 3px; flex: 1; border-radius: 2px;
      background: var(--border); transition: background 0.3s;
    }
    .pd.done { background: var(--primary); }

    /* Steps */
    .step { display: none; }
    .step.active { display: block; }

    .step-label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.06em; color: var(--text-3); margin-bottom: 14px;
    }
    .step-title {
      font-size: 20px; font-weight: 700; margin-bottom: 6px;
      letter-spacing: -0.02em;
    }
    .step-desc {
      font-size: 13px; color: var(--text-2); margin-bottom: 22px;
      line-height: 1.55;
    }

    /* Form */
    .fg { margin-bottom: 14px; }
    label {
      display: block; font-size: 12px; font-weight: 600;
      color: var(--text-2); margin-bottom: 5px;
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    input, select {
      width: 100%; padding: 10px 12px;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text);
      font-size: 14px; font-family: var(--font);
      outline: none; transition: border-color 0.15s;
    }
    input:focus, select:focus { border-color: var(--primary); }
    input::placeholder { color: var(--text-3); }
    select option { background: var(--bg-card); }

    /* Hint under input */
    .hint {
      font-size: 12px; color: var(--text-3);
      margin-top: 6px; line-height: 1.4;
    }
    .hint a { color: var(--primary); text-decoration: none; }
    .hint a:hover { text-decoration: underline; }

    /* Buttons */
    .btn {
      width: 100%; padding: 11px 16px; border-radius: var(--radius);
      font-size: 14px; font-weight: 600; cursor: pointer;
      border: none; transition: all 0.15s; font-family: var(--font);
      margin-top: 6px;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-d); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-ghost {
      background: none; border: 1px solid var(--border); color: var(--text-2);
    }
    .btn-ghost:hover { border-color: var(--border-hi); color: var(--text); }
    .btn-row { display: flex; gap: 8px; margin-top: 6px; }
    .btn-row .btn { margin-top: 0; }

    /* Errors */
    .err {
      font-size: 13px; color: var(--red);
      margin-top: 10px; display: none; line-height: 1.4;
    }

    /* SQL block */
    .sql-wrap {
      position: relative; margin-bottom: 8px;
    }
    .sql-block {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 12px 12px 12px 14px;
      font-family: var(--mono); font-size: 11px; color: var(--text-2);
      white-space: pre; overflow: auto; max-height: 180px;
      line-height: 1.5;
    }
    .sql-copy {
      position: absolute; top: 8px; right: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 10px;
      font-size: 11px; font-weight: 600; color: var(--text-2);
      cursor: pointer; transition: all 0.15s; font-family: var(--font);
    }
    .sql-copy:hover { border-color: var(--border-hi); color: var(--text); }
    .sql-copy.copied { color: var(--green); border-color: var(--green); }

    /* Check pill */
    .check-pill {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; font-weight: 600;
      padding: 4px 10px; border-radius: 20px;
      margin-bottom: 14px;
    }
    .check-pill.ok { background: rgba(52,211,153,0.12); color: var(--green); }
    .check-pill.fail { background: rgba(248,113,113,0.12); color: var(--red); }
    .check-pill.checking { background: var(--bg-input); color: var(--text-3); }

    /* Env vars table */
    .env-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 16px 0; }
    .env-table th {
      text-align: left; font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.05em;
      color: var(--text-3); padding: 0 0 8px;
    }
    .env-table td { padding: 6px 0; border-bottom: 1px solid var(--border); vertical-align: top; }
    .env-table td:first-child {
      font-family: var(--mono); font-size: 12px; color: var(--primary);
      white-space: nowrap; padding-right: 16px;
    }
    .env-table td:last-child { color: var(--text-2); }
    .env-table tr:last-child td { border-bottom: none; }

    /* Step 4 done */
    .done-icon { font-size: 48px; text-align: center; margin-bottom: 16px; }
    .done-title { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 8px; letter-spacing: -0.02em; }
    .done-text { font-size: 14px; color: var(--text-2); text-align: center; line-height: 1.6; margin-bottom: 24px; }
    .done-note {
      font-size: 12px; color: var(--text-3); text-align: center;
      padding: 12px; background: var(--bg-input);
      border: 1px solid var(--border); border-radius: var(--radius);
      margin-bottom: 8px; line-height: 1.5;
    }
  </style>
</head>
<body>
  <script src="/api/init"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Loading -->
  <div id="screen-loading">
    <div class="spinner"></div>
    Checking your setup…
  </div>

  <!-- No Supabase URL — deployer needs to set Vercel env vars -->
  <div id="screen-noenv" style="display:none">
    <div class="logo">Meitheal</div>
    <div class="logo-sub">Almost there — one step before the wizard.</div>

    <p style="font-size:14px;line-height:1.6;margin-bottom:20px;">
      Your Vercel deployment needs five environment variables before setup can begin.
      Add them in Vercel, redeploy, then come back to this page.
    </p>

    <p style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-3);margin-bottom:10px;">
      Vercel → Project → Settings → Environment Variables
    </p>

    <table class="env-table">
      <thead>
        <tr><th>Variable</th><th>Where to find it</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>SUPABASE_URL</td>
          <td>Supabase → Project Settings → API → Project URL</td>
        </tr>
        <tr>
          <td>SUPABASE_ANON_KEY</td>
          <td>Supabase → Project Settings → API → anon public key</td>
        </tr>
        <tr>
          <td>SUPABASE_SERVICE_KEY</td>
          <td>Supabase → Project Settings → API → service_role key</td>
        </tr>
        <tr>
          <td>GITHUB_TOKEN</td>
          <td>GitHub → Settings → Developer Settings → Personal access tokens → Fine-grained token with Contents: read &amp; write on this repo</td>
        </tr>
        <tr>
          <td>GITHUB_REPO</td>
          <td>Your repo in <code style="font-family:var(--mono);font-size:11px;color:var(--primary)">owner/repo</code> format, e.g. <code style="font-family:var(--mono);font-size:11px;color:var(--primary)">acmecorp/acme-community</code></td>
        </tr>
      </tbody>
    </table>

    <p style="font-size:13px;color:var(--text-2);margin-bottom:20px;line-height:1.5;">
      After adding the variables, trigger a redeploy in Vercel (Deployments → Redeploy).
      Then refresh this page.
    </p>

    <button class="btn btn-primary" onclick="location.reload()">Refresh →</button>
  </div>

  <!-- Main wizard -->
  <div id="card" style="display:none">
    <div class="logo">Meitheal</div>
    <div class="logo-sub">Set up your community in a few minutes.</div>

    <div class="progress">
      <div class="pd done" id="pd1"></div>
      <div class="pd" id="pd2"></div>
      <div class="pd" id="pd3"></div>
      <div class="pd" id="pd4"></div>
    </div>

    <!-- Step 1: Community -->
    <div class="step active" id="step-1">
      <div class="step-label">Step 1 of 4</div>
      <div class="step-title">Your community</div>
      <div class="step-desc">Give your community a name. You'll become the founding admin — anyone you invite joins as a member.</div>

      <div class="fg">
        <label>Community name</label>
        <input type="text" id="community-name" placeholder="e.g. Stoneybatter Mutual Aid">
      </div>
      <div class="fg">
        <label>Your email</label>
        <input type="email" id="admin-email" placeholder="you@example.com">
      </div>
      <div class="fg">
        <label>Your name</label>
        <input type="text" id="admin-name" placeholder="How members will see you">
      </div>
      <div class="fg">
        <label>What kind of community is this?</label>
        <select id="community-type" onchange="updateCharterPreview()">
          <option value="">— Choose one (optional) —</option>
          <option value="residents">Residents' Association</option>
          <option value="mutual-aid">Mutual Aid Group</option>
          <option value="sports">Sports Club</option>
          <option value="housing">Housing Co-op / Tenant Group</option>
          <option value="other">Other</option>
        </select>
        <div class="hint">We'll pre-fill your community charter with a relevant starting point.</div>
      </div>

      <div class="err" id="err-1"></div>
      <button class="btn btn-primary" onclick="s1Next()">Continue →</button>
    </div>

    <!-- Step 2: AI provider -->
    <div class="step" id="step-2">
      <div class="step-label">Step 2 of 4</div>
      <div class="step-title">Choose your AI</div>
      <div class="step-desc">The AI builds and evolves your platform when the community votes to add something. You can change provider any time from the admin panel.</div>

      <div class="fg">
        <label>Provider</label>
        <select id="ai-provider" onchange="updateAiFields()">
          <option value="anthropic">Anthropic (Claude) — Recommended</option>
          <option value="deepseek">DeepSeek — Best value (~$0.28 / million tokens)</option>
          <option value="openai">OpenAI (GPT-4o)</option>
          <option value="groq">Groq — Fast, free tier available</option>
          <option value="ollama">Ollama — Local, fully free</option>
        </select>
      </div>

      <div class="fg" id="model-group">
        <label>Model</label>
        <select id="ai-model">
          <option value="claude-sonnet-4-6">Claude Sonnet 4.6 — Best balance</option>
          <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 — Faster, cheaper</option>
          <option value="claude-opus-4-6">Claude Opus 4.6 — Most capable</option>
        </select>
      </div>

      <div class="fg" id="apikey-group">
        <label>API Key</label>
        <input type="password" id="ai-api-key" placeholder="sk-ant-...">
        <div class="hint" id="apikey-hint">
          Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>. New accounts get free credits.
        </div>
      </div>

      <div class="fg" id="ollama-group" style="display:none">
        <label>Ollama URL</label>
        <input type="text" id="ollama-url" value="http://localhost:11434">
        <div class="hint">Ollama must be running and accessible from your Vercel functions. Works best if you're self-hosting.</div>
      </div>

      <div class="err" id="err-2"></div>
      <button class="btn btn-primary" onclick="s2Next()">Continue →</button>
      <button class="btn btn-ghost" onclick="goStep(1)">← Back</button>
    </div>

    <!-- Step 3: Database setup -->
    <div class="step" id="step-3">
      <div class="step-label">Step 3 of 4</div>
      <div class="step-title" id="s3-title">Setting up the database…</div>
      <div class="step-desc" id="s3-desc">Creating the tables your community needs. This takes a few seconds.</div>

      <!-- Auto-migration UI (shown by default) -->
      <div id="s3-auto">
        <div style="text-align:center;padding:32px 0">
          <div class="spinner" style="margin:0 auto 16px"></div>
          <div id="s3-status" style="font-size:13px;color:var(--text-2)">Running migrations…</div>
        </div>
        <div id="db-check-pill" style="display:none"></div>
        <div class="err" id="err-3"></div>
        <button class="btn btn-primary" id="btn-verify" style="display:none" onclick="submitSetup()">Continue →</button>
        <button class="btn btn-ghost" style="display:none" id="btn-retry-migrate" onclick="runAutoMigrate()">Try again →</button>
      </div>

      <!-- Manual fallback UI (shown if SUPABASE_ACCESS_TOKEN not set) -->
      <div id="s3-manual" style="display:none">
        <p style="font-size:13px;color:var(--text-2);margin-bottom:12px;line-height:1.5;">
          Copy this SQL and run it in your Supabase SQL editor. It creates the tables your community needs.
        </p>
        <div class="sql-wrap">
          <pre class="sql-block" id="sql-block">Loading migrations…</pre>
          <button class="sql-copy" id="sql-copy-btn" onclick="copySql()">Copy</button>
        </div>
        <div class="btn-row" style="margin-bottom:16px">
          <a class="btn btn-ghost" id="sql-editor-link" href="https://supabase.com/dashboard" target="_blank"
             style="text-decoration:none;display:flex;align-items:center;justify-content:center;flex:1">
            Open SQL Editor ↗
          </a>
        </div>
        <div id="db-check-pill-manual" style="display:none"></div>
        <div class="err" id="err-3-manual"></div>
        <button class="btn btn-primary" id="btn-verify-manual" onclick="s3VerifyManual()">I've run the SQL → Verify &amp; continue</button>
      </div>

      <button class="btn btn-ghost" onclick="goStep(2)" style="margin-top:8px">← Back</button>
    </div>

    <!-- Step 4: Done -->
    <div class="step" id="step-4">
      <div class="done-icon">✅</div>
      <div class="done-title">You're all set!</div>
      <div class="done-text">
        A login link is on its way to <strong id="done-email"></strong>.<br>
        Open it to sign in as admin and start building with your community.
      </div>
      <div class="done-note" id="done-note">
        Didn't get the email? Check your spam folder, or visit
        <a href="auth.html" style="color:var(--primary)">auth.html</a>
        to request a new one.
      </div>
      <div class="done-note">
        Your Supabase Access Token is no longer needed — the database is set up. To revoke it:
        go to <a href="https://supabase.com/dashboard/account/tokens" target="_blank" style="color:var(--primary)">supabase.com/dashboard/account/tokens ↗</a>,
        find the token named <em>Meitheal setup</em>, and click <strong>Revoke</strong>.
        You can also remove <code style="font-size:11px">SUPABASE_ACCESS_TOKEN</code> from your Vercel environment variables.
      </div>

      <div style="margin:20px 0;padding:16px;background:var(--bg-muted);border:1px solid var(--border);border-radius:var(--radius);text-align:left">
        <p style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-3);margin-bottom:8px">Before you invite anyone</p>
        <p style="font-size:13px;color:var(--text-2);line-height:1.55;margin-bottom:12px">
          The sign-in email your members receive comes from Supabase and mentions no community name by default. Personalise it so people know what they've been invited to.
        </p>
        <p style="font-size:13px;color:var(--text-2);line-height:1.55;margin-bottom:12px">
          In Supabase: <strong style="color:var(--text)">Authentication → Email Templates → Magic Link</strong><br>
          Change the subject to something like <em>"You've been invited to join <span id="done-community-name">your community</span>"</em> and add a line explaining what the platform is.
        </p>
        <a id="email-template-link" href="https://supabase.com/dashboard" target="_blank"
           style="display:inline-block;font-size:13px;font-weight:600;color:var(--primary);text-decoration:none">
          Open Email Templates in Supabase ↗
        </a>
      </div>

      <button class="btn btn-primary" onclick="window.location.href='auth.html'">Go to login →</button>
    </div>
  </div>

  <script>
    // ---- State ----
    let step = 1;
    let form = {};
    let sqlText = null;

    const MIGRATIONS = [
      'migrations/00_base.sql',
      'migrations/01_proposals.sql',
      'migrations/02_trust_validation.sql',
      'migrations/03_admin_rls.sql',
      'migrations/04_member_proposal_rls.sql',
      'migrations/05_run_sql_function.sql',
      'migrations/09_votes.sql',
    ];

    // ---- Boot: detect state ----

    async function boot() {
      const supabaseUrl  = window._SUPABASE_URL  || '';
      const supabaseAnon = window._SUPABASE_ANON_KEY || '';

      // Supabase not configured — deployer needs to set env vars
      if (!supabaseUrl || supabaseUrl.includes('YOUR_PROJECT')) {
        show('screen-noenv');
        return;
      }

      // Try to read settings to detect setup state
      try {
        const r = await fetch(`${supabaseUrl}/rest/v1/settings?key=eq.initialized&select=value`, {
          headers: {
            'apikey':        supabaseAnon,
            'Authorization': `Bearer ${supabaseAnon}`,
          }
        });

        if (r.ok) {
          const rows = await r.json();
          if (rows?.[0]?.value === 'true') {
            // Already initialised — redirect to auth
            window.location.replace('auth.html');
            return;
          }
          // Tables exist but not yet initialised — skip SQL step
          form._dbReady = true;
        }
        // If r is not ok: tables probably don't exist yet (expected on first run)
      } catch {}

      // Restore form data from sessionStorage (so refreshes don't lose progress)
      try {
        const saved = JSON.parse(sessionStorage.getItem('mth_setup') || '{}');
        Object.assign(form, saved);
        if (form.communityName) document.getElementById('community-name').value = form.communityName;
        if (form.adminEmail)    document.getElementById('admin-email').value    = form.adminEmail;
        if (form.adminName)     document.getElementById('admin-name').value     = form.adminName;
      } catch {}

      show('card');
      // If DB is already ready, we only need to collect config then submit
      // Stay on step 1 regardless — still need to collect community name etc.
    }

    function show(id) {
      document.getElementById('screen-loading').style.display = 'none';
      document.getElementById('screen-noenv').style.display   = 'none';
      document.getElementById('card').style.display           = 'none';
      document.getElementById(id).style.display = '';
    }

    // ---- Navigation ----

    function goStep(n) {
      document.getElementById(`step-${step}`).classList.remove('active');
      document.getElementById(`step-${n}`).classList.add('active');
      for (let i = 1; i <= 4; i++) {
        document.getElementById(`pd${i}`).classList.toggle('done', i <= n);
      }
      step = n;

      if (n === 3) initSqlStep();
    }

    // ---- Step 1 ----

    const COMMUNITY_CHARTERS = {
      'residents': `This is a residents' association — a platform for neighbours to share ideas, flag problems, and shape the local area together.\n\nIdeas go through a transparent process: submitted by members, reviewed by stewards, approved by admins, then built by the AI agent with full community credit.\n\nEveryone's voice counts. Every decision is recorded.`,
      'mutual-aid': `This is a mutual aid group — a community of neighbours helping neighbours. We build tools that make it easier to offer help, request support, and share what we have.\n\nNo one leads, everyone contributes. Ideas are shared openly, decisions are made together, and what gets built reflects what the community actually needs.\n\nHelp is not charity — it is community.`,
      'sports': `This is a sports club — a platform for members to communicate, organise, and grow together.\n\nMembers can suggest new features, vote on what matters, and see their ideas turned into real tools. The club is run for members, by members.\n\nWhat we build here reflects what we need on and off the pitch.`,
      'housing': `This is a housing co-op or tenant group — a democratic community where residents shape how we live together.\n\nAll decisions are transparent. Members propose, the community debates, admins approve, and every build is recorded in the changelog. No one acts alone.\n\nThis platform belongs to the residents.`,
      'other': `This is a community platform built and shaped by its members.\n\nAnyone can submit an idea. Good ideas become proposals. Proposals get approved and built. Everything is logged.\n\nWhat this community builds reflects what this community actually needs.`,
    };

    function updateCharterPreview() { /* future: show preview */ }

    function s1Next() {
      clearErr('err-1');
      const name          = v('community-name');
      const email         = v('admin-email');
      const adminName     = v('admin-name');
      const communityType = v('community-type');
      if (!name)  return err('err-1', 'Please enter a community name.');
      if (!email || !email.includes('@')) return err('err-1', 'Please enter a valid email address.');
      if (!adminName) return err('err-1', 'Please enter your name.');
      const charter = communityType ? COMMUNITY_CHARTERS[communityType] || '' : '';
      Object.assign(form, { communityName: name, adminEmail: email, adminName, communityType, communityCharter: charter });
      save();
      goStep(2);
    }

    // ---- Step 2 ----

    function updateAiFields() {
      const provider = v('ai-provider');

      const models = {
        anthropic: [
          ['claude-sonnet-4-6',        'Claude Sonnet 4.6 — Best balance'],
          ['claude-haiku-4-5-20251001', 'Claude Haiku 4.5 — Faster, cheaper'],
          ['claude-opus-4-6',          'Claude Opus 4.6 — Most capable'],
        ],
        deepseek: [
          ['deepseek-chat',     'DeepSeek V3 — ~$0.28/M tokens'],
          ['deepseek-reasoner', 'DeepSeek R1 — reasoning model'],
        ],
        openai: [
          ['gpt-4o',      'GPT-4o — Best'],
          ['gpt-4o-mini', 'GPT-4o Mini — Cheaper'],
        ],
        groq: [
          ['llama-3.3-70b-versatile', 'Llama 3.3 70B'],
          ['mixtral-8x7b-32768',      'Mixtral 8x7B'],
        ],
        ollama: [
          ['llama3',   'llama3'],
          ['mistral',  'mistral'],
          ['codellama','codellama'],
        ],
      };

      const hints = {
        anthropic: 'Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>. New accounts get free credits.',
        deepseek:  'Get your key at <a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a>. Very affordable.',
        openai:    'Get your key at <a href="https://platform.openai.com" target="_blank">platform.openai.com</a>.',
        groq:      'Free API key at <a href="https://console.groq.com" target="_blank">console.groq.com</a>.',
      };

      const sel = document.getElementById('ai-model');
      sel.innerHTML = (models[provider] || []).map(([v,l]) => `<option value="${v}">${l}</option>`).join('');

      document.getElementById('ollama-group').style.display  = provider === 'ollama' ? 'block' : 'none';
      document.getElementById('apikey-group').style.display  = provider === 'ollama' ? 'none'  : 'block';

      const hint = document.getElementById('apikey-hint');
      if (hints[provider]) hint.innerHTML = hints[provider];
    }

    function s2Next() {
      clearErr('err-2');
      const provider  = v('ai-provider');
      const model     = v('ai-model');
      const apiKey    = v('ai-api-key');
      const ollamaUrl = v('ollama-url');
      if (provider !== 'ollama' && !apiKey) return err('err-2', 'Please enter your API key.');
      Object.assign(form, { provider, model, apiKey, ollamaUrl });
      save();
      goStep(3);
    }

    // ---- Step 3: Database setup ----

    async function loadSql() {
      if (sqlText) return sqlText;
      try {
        const parts = await Promise.all(
          MIGRATIONS.map(async (path) => {
            const r = await fetch(path);
            if (!r.ok) throw new Error(`Could not load ${path}`);
            return await r.text();
          })
        );
        sqlText = parts.join('\n\n');
      } catch (e) {
        sqlText = '-- Error loading migrations: ' + e.message;
      }
      return sqlText;
    }

    async function initSqlStep() {
      if (form._dbReady) {
        // DB already confirmed — skip straight to submit
        document.getElementById('s3-title').textContent = 'Database ready';
        document.getElementById('s3-desc').textContent  = 'The database is already set up.';
        document.getElementById('s3-status').textContent = '✓ Database already set up';
        document.getElementById('s3-status').style.color = 'var(--green)';
        document.querySelector('#s3-auto .spinner').style.display = 'none';
        document.getElementById('btn-verify').style.display = '';
        return;
      }
      await runAutoMigrate();
    }

    async function runAutoMigrate() {
      document.getElementById('s3-auto').style.display   = '';
      document.getElementById('s3-manual').style.display = 'none';
      document.getElementById('s3-title').textContent    = 'Setting up the database…';
      document.getElementById('s3-desc').textContent     = 'Creating the tables your community needs.';
      document.getElementById('s3-status').textContent   = 'Running migrations…';
      document.getElementById('s3-status').style.color   = '';
      document.querySelector('#s3-auto .spinner').style.display = '';
      document.getElementById('btn-verify').style.display        = 'none';
      document.getElementById('btn-retry-migrate').style.display = 'none';
      document.getElementById('db-check-pill').style.display     = 'none';
      clearErr('err-3');

      const sql = await loadSql();

      try {
        const r = await fetch('/api/setup', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ action: 'migrate', sql }),
        });
        const json = await r.json();

        // Server says SUPABASE_ACCESS_TOKEN not set — fall back to manual
        if (json.fallback) {
          showManualFallback();
          return;
        }

        if (!r.ok || !json.ok) throw new Error(json.error || 'Migration failed');

        // Success
        document.querySelector('#s3-auto .spinner').style.display = 'none';
        document.getElementById('s3-status').textContent = `✓ Database ready (${json.ran} statements run)`;
        document.getElementById('s3-status').style.color = 'var(--green)';
        document.getElementById('s3-title').textContent  = 'Database ready';
        document.getElementById('s3-desc').textContent   = 'Tables created. Finishing setup…';
        form._dbReady = true;
        // Auto-advance
        await submitSetup();

      } catch (e) {
        document.querySelector('#s3-auto .spinner').style.display = 'none';
        err('err-3', `Migration error: ${e.message}`);
        document.getElementById('btn-retry-migrate').style.display = '';
      }
    }

    function showManualFallback() {
      document.getElementById('s3-auto').style.display   = 'none';
      document.getElementById('s3-manual').style.display = '';
      document.getElementById('s3-title').textContent    = 'Set up the database';
      document.getElementById('s3-desc').textContent     = 'Copy this SQL and run it in your Supabase SQL editor.';

      document.getElementById('sql-block').textContent = sqlText || 'Loading…';

      const ref = (window._SUPABASE_URL || '').replace('https://', '').split('.')[0];
      if (ref && ref !== 'YOUR_PROJECT') {
        document.getElementById('sql-editor-link').href =
          `https://supabase.com/dashboard/project/${ref}/sql/new`;
      }
    }

    async function copySql() {
      if (!sqlText) return;
      const btn = document.getElementById('sql-copy-btn');
      try {
        await navigator.clipboard.writeText(sqlText);
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2500);
      } catch {
        btn.textContent = 'Select + copy manually';
      }
    }

    async function s3VerifyManual() {
      clearErr('err-3-manual');
      const btn = document.getElementById('btn-verify-manual');
      btn.disabled    = true;
      btn.textContent = 'Checking…';

      const pill = document.getElementById('db-check-pill-manual');
      pill.style.display = 'block';
      pill.innerHTML = '<span class="check-pill checking">Checking database…</span>';

      try {
        const r    = await fetch('/api/setup', {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ action: 'check' }),
        });
        const json = await r.json();
        if (!r.ok || !json.ok) throw new Error(json.error || 'Database not ready');

        pill.innerHTML = '<span class="check-pill ok">✓ Database ready</span>';
        form._dbReady  = true;
        await submitSetup();
      } catch (e) {
        pill.innerHTML = '<span class="check-pill fail">✗ Tables not found</span>';
        err('err-3-manual', 'The database tables weren\'t found. Make sure you copied and ran the full SQL block, then try again.');
        btn.disabled    = false;
        btn.textContent = 'Try again →';
      }
    }

    function showDbPill(state, text) {
      const el = document.getElementById('db-check-pill');
      el.style.display = 'block';
      el.innerHTML = `<span class="check-pill ${state}">${text}</span>`;
    }

    // ---- Submit to /api/setup ----

    async function submitSetup() {
      // Disable whichever verify button is visible
      ['btn-verify', 'btn-verify-manual'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = true; el.textContent = 'Saving…'; }
      });

      const siteUrl = window.location.origin;

      try {
        const r = await fetch('/api/setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            communityName:    form.communityName,
            adminEmail:       form.adminEmail,
            adminName:        form.adminName,
            provider:         form.provider,
            model:            form.model,
            apiKey:           form.apiKey,
            ollamaUrl:        form.ollamaUrl,
            communityCharter: form.communityCharter || '',
            siteUrl,
          }),
        });
        const json = await r.json();
        if (!r.ok) throw new Error(json.error || 'Setup failed');

        // Clear saved form data — setup complete
        sessionStorage.removeItem('mth_setup');

        document.getElementById('done-email').textContent = form.adminEmail;

        // Populate Step 4 email branding callout
        if (form.communityName) {
          document.getElementById('done-community-name').textContent = form.communityName;
        }
        const ref = (window._SUPABASE_URL || '').replace('https://', '').split('.')[0];
        if (ref && !ref.includes('YOUR_PROJECT')) {
          document.getElementById('email-template-link').href =
            `https://supabase.com/dashboard/project/${ref}/auth/templates`;
        }

        goStep(4);
      } catch (e) {
        ['btn-verify', 'btn-verify-manual'].forEach(id => {
          const el = document.getElementById(id);
          if (el && el.style.display !== 'none') {
            el.disabled = false; el.textContent = 'Try again →';
          }
        });
        err('err-3', e.message);
        err('err-3-manual', e.message);
      }
    }

    // ---- Helpers ----

    function v(id) { return document.getElementById(id)?.value?.trim() || ''; }

    function err(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg; el.style.display = 'block';
    }

    function clearErr(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    }

    function save() {
      try {
        sessionStorage.setItem('mth_setup', JSON.stringify({
          communityName: form.communityName,
          adminEmail:    form.adminEmail,
          adminName:     form.adminName,
        }));
      } catch {}
    }

    // ---- Start ----
    boot();
  </script>
</body>
</html>
