<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign in — Meitheal</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f0f0f; --bg-card: #1a1a1a; --bg-input: #242424;
      --border: #2e2e2e; --text: #e8e8e8; --text-2: #999; --text-3: #555;
      --primary: #4f8ef7; --green: #3dd68c; --red: #f87171;
      --radius: 10px; --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    body {
      background: var(--bg); color: var(--text); font-family: var(--font);
      min-height: 100dvh; display: flex; align-items: center; justify-content: center; padding: 24px;
    }
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; padding: 40px; max-width: 380px; width: 100%;
    }
    .logo { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .community { font-size: 14px; color: var(--text-2); margin-bottom: 28px; }
    label { display: block; font-size: 13px; font-weight: 500; color: var(--text-2); margin-bottom: 6px; }
    input {
      width: 100%; padding: 10px 12px;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text); font-size: 14px; outline: none;
      transition: border-color 0.15s;
    }
    input:focus { border-color: var(--primary); }
    input::placeholder { color: var(--text-3); }
    .btn {
      width: 100%; padding: 12px; border-radius: var(--radius); margin-top: 12px;
      font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
    .msg { font-size: 13px; margin-top: 12px; padding: 10px 12px; border-radius: 8px; display: none; }
    .msg.success { background: rgba(61,214,140,0.1); color: var(--green); border: 1px solid rgba(61,214,140,0.2); }
    .msg.error   { background: rgba(248,113,113,0.1); color: var(--red); border: 1px solid rgba(248,113,113,0.2); }
    .loading { text-align: center; padding: 20px; color: var(--text-2); font-size: 14px; display: none; }
  </style>
</head>
<body>
  <script src="/api/init"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <div class="card">
    <div class="logo">Meitheal</div>
    <div class="community" id="community-label">Sign in to your community</div>

    <div class="loading" id="loading">Signing you in…</div>

    <div id="form-area">
      <label for="email">Email address</label>
      <input type="email" id="email" placeholder="you@example.com" autofocus
             onkeydown="if(event.key==='Enter') sendLink()">
      <button class="btn btn-primary" id="send-btn" onclick="sendLink()">Send sign-in link</button>
      <div class="msg" id="msg"></div>
    </div>
  </div>

  <script>
    function getSupabase() {
      if (!window._sb) {
        window._sb = supabase.createClient(
          document.querySelector('meta[name="supabase-url"]')?.content || window._SUPABASE_URL || '',
          document.querySelector('meta[name="supabase-anon"]')?.content || window._SUPABASE_ANON_KEY || ''
        );
      }
      return window._sb;
    }

    async function init() {
      const sb = getSupabase();

      // Handle magic link token in URL
      const hash = window.location.hash;
      if (hash && (hash.includes('access_token') || hash.includes('error'))) {
        document.getElementById('form-area').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading').textContent = 'Signing you in…';

        const { data, error } = await sb.auth.getSession();
        if (error || !data.session) {
          document.getElementById('loading').textContent = 'Sign-in failed. Please try again.';
          setTimeout(() => { window.location.href = 'auth.html'; }, 2000);
          return;
        }

        // Link auth_id server-side (client can't do this due to RLS)
        const linkR = await fetch('/api/link-auth', {
          method:  'POST',
          headers: { 'Authorization': `Bearer ${data.session.access_token}` }
        });

        if (!linkR.ok) {
          const err = await linkR.json().catch(() => ({}));
          document.getElementById('loading').textContent =
            err.error || 'Sign-in failed. Please contact your community admin.';
          return;
        }

        const { role } = await linkR.json();
        window.location.href = role === 'admin' ? 'admin.html' : 'home.html';
        return;
      }

      // Already logged in?
      const { data: { session } } = await sb.auth.getSession();
      if (session) {
        const { data: members } = await sb.from('members').select('role').eq('auth_id', session.user.id);
        window.location.href = members?.[0]?.role === 'admin' ? 'admin.html' : 'index.html';
        return;
      }

      // Load community name
      const { data: settings } = await sb.from('settings').select('value').eq('key', 'community_name').single();
      if (settings?.value) {
        document.getElementById('community-label').textContent = `Sign in to ${settings.value}`;
        document.title = `Sign in — ${settings.value}`;
      }
    }

    async function sendLink() {
      const email = document.getElementById('email').value.trim();
      const msg   = document.getElementById('msg');
      const btn   = document.getElementById('send-btn');
      msg.style.display = 'none';

      if (!email || !email.includes('@')) {
        msg.textContent = 'Please enter a valid email address.';
        msg.className = 'msg error';
        msg.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Sending…';

      const sb = getSupabase();
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.origin + '/auth.html' }
      });

      btn.disabled = false;
      btn.textContent = 'Send sign-in link';

      if (error) {
        msg.textContent = error.message;
        msg.className = 'msg error';
      } else {
        msg.textContent = 'Check your email — a sign-in link is on its way.';
        msg.className = 'msg success';
      }
      msg.style.display = 'block';
    }

    init();
  </script>
</body>
</html>
