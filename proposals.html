<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Proposals ‚Äî Meitheal</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    .page {
      max-width: 680px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-5);
      min-height: 100vh;
      animation: pageIn 300ms ease-out both;
    }

    @keyframes pageIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .page-header {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--color-border);
    }

    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: transparent;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-text-muted);
      text-decoration: none;
      transition: all var(--transition-fast);
      flex-shrink: 0;
      margin-top: 6px;
    }

    .back-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background: var(--color-primary-bg);
    }

    .page-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      line-height: 1.1;
      margin-bottom: var(--space-1);
    }

    .page-sub {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin-bottom: var(--space-5);
      line-height: var(--line-height-relaxed);
    }

    /* Filter tabs */
    .filter-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .filter-tabs::-webkit-scrollbar { display: none; }

    .tab-btn {
      flex-shrink: 0;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      padding: var(--space-2) var(--space-4);
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .tab-btn:hover { border-color: var(--color-primary-lighter); color: var(--color-text); }

    .tab-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-text-inverse);
    }

    /* Proposal cards */
    .proposals-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .proposal-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      transition: box-shadow var(--transition-fast);
    }

    .proposal-card:hover { box-shadow: var(--shadow-sm); }

    .proposal-card.status-proposed  { border-left: 3px solid var(--color-accent); }
    .proposal-card.status-approved  { border-left: 3px solid var(--color-status-accepted); }
    .proposal-card.status-building  { border-left: 3px solid var(--color-primary); }
    .proposal-card.status-done      { border-left: 3px solid var(--color-status-accepted); opacity: 0.8; }
    .proposal-card.status-declined  { border-left: 3px solid var(--color-border); opacity: 0.6; }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .proposal-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      line-height: var(--line-height-tight);
    }

    .status-chip {
      flex-shrink: 0;
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 3px var(--space-3);
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    .status-chip.proposed  { background: var(--color-accent-bg);          color: var(--color-accent-dark); }
    .status-chip.approved  { background: var(--color-status-accepted-bg);  color: var(--color-status-accepted); }
    .status-chip.building  { background: var(--color-primary-bg);          color: var(--color-primary); }
    .status-chip.done      { background: var(--color-status-accepted-bg);  color: var(--color-status-accepted); }
    .status-chip.declined  { background: var(--color-bg-muted);            color: var(--color-text-light); }

    .proposal-description {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--space-3);
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
      font-size: var(--font-size-xs);
      color: var(--color-text-light);
    }

    .suggested-by {
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
    }

    /* Clarification note */
    .clarification-note {
      margin-top: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--color-primary-bg);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--color-primary-lighter);
    }

    .clarification-note .note-label {
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: var(--space-1);
    }

    .clarification-note p {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-normal);
    }

    /* Clarification input (for original submitter) */
    .clarify-toggle {
      background: none;
      border: none;
      font-family: var(--font-family);
      font-size: var(--font-size-xs);
      color: var(--color-primary);
      cursor: pointer;
      padding: 0;
      margin-top: var(--space-2);
    }

    .clarify-form {
      margin-top: var(--space-3);
      display: none;
    }

    .clarify-form.open { display: block; }

    .clarify-textarea {
      width: 100%;
      background: var(--color-bg-muted);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-text);
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      padding: var(--space-3) var(--space-4);
      resize: none;
      height: 80px;
      outline: none;
      box-sizing: border-box;
      margin-bottom: var(--space-2);
    }

    .clarify-textarea:focus { border-color: var(--color-primary); }

    .clarify-actions {
      display: flex;
      gap: var(--space-2);
      justify-content: flex-end;
    }

    .clarify-btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      font-family: var(--font-family);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      border: 1px solid var(--color-border);
      transition: all var(--transition-fast);
    }

    .clarify-btn-ghost { background: none; color: var(--color-text-muted); }
    .clarify-btn-primary {
      background: var(--color-primary);
      color: var(--color-text-inverse);
      border-color: var(--color-primary);
    }

    /* Vote button */
    .vote-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-light);
    }

    .vote-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-muted);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-full);
      font-family: var(--font-family);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .vote-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
      background: var(--color-primary-bg);
    }

    .vote-btn.voted {
      background: var(--color-primary-bg);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .vote-count {
      font-size: var(--font-size-xs);
      color: var(--color-text-light);
    }

    /* Empty state */
    .state-msg {
      text-align: center;
      padding: var(--space-12) var(--space-6);
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
    }

    .state-msg .icon { font-size: 32px; margin-bottom: var(--space-3); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(8px);
      background: var(--color-text);
      color: var(--color-text-inverse);
      padding: var(--space-3) var(--space-5);
      border-radius: var(--radius-lg);
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      box-shadow: var(--shadow-lg);
      z-index: 1100;
      opacity: 0;
      transition: all 0.2s;
      pointer-events: none;
      white-space: nowrap;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>
</head>
<body>
  <script src="/api/init"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="feedback-widget.js"></script>

  <div class="page">
    <header class="page-header">
      <a href="home.html" class="back-btn" aria-label="Back to home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
      </a>
      <div>
        <h1 class="page-title">Proposals</h1>
        <p class="page-sub">Ideas from your community ‚Äî approved proposals are built by an AI agent on the community's behalf.</p>
      </div>
    </header>

    <div class="filter-tabs">
      <button class="tab-btn active" data-filter="active" onclick="setFilter('active')">Open</button>
      <button class="tab-btn" data-filter="proposed" onclick="setFilter('proposed')">Proposed</button>
      <button class="tab-btn" data-filter="building" onclick="setFilter('building')">Building</button>
      <button class="tab-btn" data-filter="done" onclick="setFilter('done')">Done</button>
      <button class="tab-btn" data-filter="all" onclick="setFilter('all')">All</button>
    </div>

    <div id="state" class="state-msg">
      <div class="icon">üìã</div>
      Loading proposals‚Ä¶
    </div>

    <div class="proposals-list" id="proposals-list" style="display:none"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const FILTER_FN = {
      active:   p => p.status === 'proposed' || p.status === 'approved' || p.status === 'building',
      proposed: p => p.status === 'proposed',
      building: p => p.status === 'approved' || p.status === 'building',
      done:     p => p.status === 'done',
      all:      ()=> true,
    };

    const STATUS_LABEL = {
      proposed: 'Proposed',
      approved: 'Approved',
      building: 'Building now',
      done:     'Done',
      declined: 'Declined',
    };

    let allProposals = [];
    let currentFilter = 'active';
    let currentMember = null;
    let votesByProposal = {}; // { proposalId: Set of member_ids who voted }
    let myVotedIds = new Set(); // proposal_ids the current member has voted on

    async function init() {
      const member = await requireAuthAsync();
      if (!member) return;
      currentMember = member;

      initFeedbackWidget(member.id);

      try {
        allProposals = await getAllProposals();
        // Load votes for all proposals
        const ids = allProposals.map(p => p.id);
        const votes = ids.length ? await getVotesForProposals(ids) : [];
        votesByProposal = {};
        myVotedIds = new Set();
        for (const v of votes) {
          if (!votesByProposal[v.proposal_id]) votesByProposal[v.proposal_id] = new Set();
          votesByProposal[v.proposal_id].add(v.member_id);
          if (v.member_id === member.id) myVotedIds.add(v.proposal_id);
        }
        render();
      } catch (e) {
        console.error(e);
        document.getElementById('state').innerHTML = '<div class="icon">‚ö†Ô∏è</div>Could not load proposals.';
      }
    }

    function setFilter(f) {
      currentFilter = f;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === f);
      });
      render();
    }

    function render() {
      const items = allProposals.filter(FILTER_FN[currentFilter]);
      const state = document.getElementById('state');
      const list  = document.getElementById('proposals-list');

      if (items.length === 0) {
        list.style.display = 'none';
        const labels = {
          active:   'No open proposals yet.',
          proposed: 'No proposals waiting for approval.',
          building: 'Nothing being built right now.',
          done:     'Nothing completed yet.',
          all:      'No proposals yet.',
        };
        state.innerHTML = `<div class="icon">üìã</div>${labels[currentFilter]}`;
        state.style.display = 'block';
        return;
      }

      state.style.display = 'none';
      list.style.display = 'flex';
      list.innerHTML = items.map(p => buildCard(p)).join('');
    }

    function buildCard(p) {
      const promoter = p.members?.display_name || 'Admin';
      const suggestedBy = p.feedback?.length
        ? p.feedback.map(f => `#${String(f.ref_number).padStart(3,'0')}`).join(', ')
        : null;
      const date = timeAgo(p.created_at);
      const statusLabel = STATUS_LABEL[p.status] || p.status;

      // Is current member the original submitter?
      const isSubmitter = p.feedback?.some(f => f.author_id === currentMember.id);

      const clarificationSection = p.clarification_note
        ? `<div class="clarification-note">
            <div class="note-label">Clarification from submitter</div>
            <p>${escHtml(p.clarification_note)}</p>
          </div>`
        : (isSubmitter && p.status !== 'done' && p.status !== 'declined'
          ? `<button class="clarify-toggle" onclick="toggleClarify('${p.id}')">Add a clarification note</button>
             <div class="clarify-form" id="clarify-${p.id}">
               <textarea class="clarify-textarea" id="clarify-text-${p.id}" placeholder="If we've misunderstood what you meant, add a note here‚Ä¶"></textarea>
               <div class="clarify-actions">
                 <button class="clarify-btn clarify-btn-ghost" onclick="toggleClarify('${p.id}')">Cancel</button>
                 <button class="clarify-btn clarify-btn-primary" onclick="submitClarification('${p.id}')">Save note</button>
               </div>
             </div>`
          : '');

      // Vote row ‚Äî show for proposed/approved status so community can express interest
      const canVote = p.status === 'proposed' || p.status === 'approved';
      const voteCount = votesByProposal[p.id]?.size || 0;
      const hasVoted  = myVotedIds.has(p.id);
      const voteSection = canVote ? `
        <div class="vote-row">
          <button class="vote-btn ${hasVoted ? 'voted' : ''}" id="vote-btn-${p.id}"
            onclick="toggleVote('${p.id}', this)">
            ${hasVoted ? 'üëç Supported' : 'üëç Support this'}
          </button>
          <span class="vote-count" id="vote-count-${p.id}">${voteCount > 0 ? `${voteCount} ${voteCount === 1 ? 'vote' : 'votes'}` : ''}</span>
        </div>` : '';

      return `
        <div class="proposal-card status-${p.status}">
          <div class="card-top">
            <div class="proposal-title">${escHtml(p.title)}</div>
            <span class="status-chip ${p.status}">${statusLabel}</span>
          </div>
          ${p.description ? `<div class="proposal-description">${escHtml(p.description)}</div>` : ''}
          <div class="card-meta">
            <span>Proposed by ${escHtml(promoter)}</span>
            ${suggestedBy ? `<span>¬∑ from ${suggestedBy}</span>` : ''}
            <span>¬∑ ${date}</span>
          </div>
          ${clarificationSection}
          ${voteSection}
        </div>
      `;
    }

    async function toggleVote(proposalId, btn) {
      if (!currentMember) return;
      btn.disabled = true;
      try {
        const hasVoted = myVotedIds.has(proposalId);
        if (hasVoted) {
          await removeVote(proposalId, currentMember.id);
          myVotedIds.delete(proposalId);
          if (votesByProposal[proposalId]) votesByProposal[proposalId].delete(currentMember.id);
        } else {
          await castVote(proposalId, currentMember.id);
          myVotedIds.add(proposalId);
          if (!votesByProposal[proposalId]) votesByProposal[proposalId] = new Set();
          votesByProposal[proposalId].add(currentMember.id);
        }
        // Update button and count in place
        const nowVoted = myVotedIds.has(proposalId);
        btn.className = `vote-btn ${nowVoted ? 'voted' : ''}`;
        btn.textContent = nowVoted ? 'üëç Supported' : 'üëç Support this';
        const countEl = document.getElementById(`vote-count-${proposalId}`);
        const n = votesByProposal[proposalId]?.size || 0;
        if (countEl) countEl.textContent = n > 0 ? `${n} ${n === 1 ? 'vote' : 'votes'}` : '';
      } catch (e) {
        showToast('Could not save vote');
        console.error(e);
      } finally {
        btn.disabled = false;
      }
    }

    function toggleClarify(id) {
      const form = document.getElementById(`clarify-${id}`);
      if (form) form.classList.toggle('open');
    }

    async function submitClarification(proposalId) {
      const note = document.getElementById(`clarify-text-${proposalId}`).value.trim();
      if (!note) return;

      try {
        const { error } = await getSupabase()
          .from('proposals')
          .update({
            clarification_note: note,
            clarification_by:   currentMember.id,
            clarification_at:   new Date().toISOString(),
          })
          .eq('id', proposalId);

        if (error) throw error;

        showToast('Note saved ‚úì');
        allProposals = await getAllProposals();
        render();
      } catch (e) {
        console.error(e);
        showToast('Could not save note');
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function timeAgo(ts) {
      const diff = Date.now() - new Date(ts).getTime();
      const days = Math.floor(diff / 86400000);
      if (days < 1)  return 'today';
      if (days < 30) return `${days}d ago`;
      const months = Math.floor(days / 30);
      return months === 1 ? '1 month ago' : `${months} months ago`;
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    init();
  </script>
</body>
</html>
